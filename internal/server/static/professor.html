<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRS - –ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: Arial, Helvetica, sans-serif;
        background: #f2f2f2;
    }

    .header {
        background: #3498db;
        color: #ffffff;
        padding: 15px;
    }

    .header-content {
        max-width: 1400px;
        margin: 0 auto;
        overflow: hidden;
    }

    .logo {
        float: left;
    }

    .logo h1 {
        font-size: 20px;
    }

    .user-info {
        float: right;
        text-align: right;
    }

    .username {
        font-weight: bold;
        font-size: 14px;
    }

    .user-type {
        font-size: 12px;
    }

    .nav-buttons {
        margin-top: 5px;
    }

    .nav-btn {
        display: inline-block;
        padding: 6px 12px;
        margin-left: 5px;
        background: #ffffff;
        color: #333333;
        border: 1px solid #cccccc;
        text-decoration: none;
        cursor: pointer;
    }

    .main-content {
        max-width: 1400px;
        margin: 20px auto;
        padding: 10px;
    }

    .control-panel {
        background: #ffffff;
        padding: 20px;
        border: 1px solid #dddddd;
        margin-bottom: 20px;
    }

    .panel-title {
        font-size: 20px;
        margin-bottom: 15px;
    }

    .courses-grid {
        margin-top: 10px;
    }

    .course-card {
        border: 1px solid #cccccc;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .course-card.active {
        background: #e6f4ea;
        border-left: 4px solid #27ae60;
    }

    .course-name {
        font-size: 16px;
        font-weight: bold;
    }

    .course-subject {
        font-size: 13px;
        color: #555555;
    }

    .course-group {
        font-size: 12px;
        font-style: italic;
        color: #777777;
    }

    .attributes-section {
        margin-top: 20px;
    }

    .attributes-grid {
        overflow: hidden;
    }

    .attribute-card {
        border: 1px solid #cccccc;
        padding: 10px;
        margin-bottom: 10px;
    }

    .attribute-name {
        font-weight: bold;
        font-size: 14px;
    }

    .attribute-max {
        font-size: 12px;
        color: #555555;
    }

    .students-section {
        background: #ffffff;
        padding: 20px;
        border: 1px solid #dddddd;
    }

    .section-title {
        font-size: 18px;
        margin-bottom: 10px;
    }

    .students-table {
        width: 100%;
        border-collapse: collapse;
    }

    .students-table th,
    .students-table td {
        border: 1px solid #cccccc;
        padding: 8px;
        font-size: 13px;
    }

    .students-table th {
        background: #34495e;
        color: #ffffff;
    }

    .points-input {
        width: 70px;
        padding: 5px;
        border: 1px solid #cccccc;
        text-align: center;
    }

    .save-btn {
        padding: 6px 10px;
        background: #27ae60;
        color: #ffffff;
        border: 1px solid #1e8449;
        cursor: pointer;
    }

    .save-btn:disabled {
        background: #aaaaaa;
        border-color: #888888;
        cursor: default;
    }

    .loading {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #555555;
    }

    .error-message {
        background: #e74c3c;
        color: #ffffff;
        padding: 10px;
        margin-bottom: 10px;
    }

    .success-message {
        background: #27ae60;
        color: #ffffff;
        padding: 10px;
        margin-bottom: 10px;
    }

    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üìö BRS - –ü–∞–Ω–µ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h1>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <div class="username">{{.Username}}</div>
                    <div class="user-type">{{.UserType}}</div>
                </div>
                <div class="nav-buttons">
                    <a href="/dashboard" class="nav-btn">–ì–ª–∞–≤–Ω–∞—è</a>
                    <button class="nav-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="control-panel">
            <h2 class="panel-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–∞–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
            
            <div class="attributes-section">
                <h3 class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å:</h3>
                <div id="coursesContainer" class="courses-grid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...</div>
                </div>
            </div>

            <div id="attributesSection" class="attributes-section" style="display: none;">
                <h3 class="section-title">–ê—Ç—Ä–∏–±—É—Ç—ã –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è:</h3>
                <div id="attributesContainer" class="attributes-grid">
                    <!-- –ê—Ç—Ä–∏–±—É—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <div id="studentsSection" class="students-section" style="display: none;">
            <h3 class="section-title">–°—Ç—É–¥–µ–Ω—Ç—ã –∫—É—Ä—Å–∞</h3>
            <div id="studentsContainer">
                <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <script>
        let currentCourseId = null;
        let currentAttributes = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        async function loadCourses() {
            try {
                const response = await fetch('/api/professor/courses', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load courses');
                }
                
                const courses = await response.json();
                displayCourses(courses);
            } catch (error) {
                document.getElementById('coursesContainer').innerHTML = 
                    '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤: ' + error.message + '</div>';
            }
        }

        function displayCourses(courses) {
            const container = document.getElementById('coursesContainer');
            
            if (courses.length === 0) {
                container.innerHTML = '<div class="loading">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</div>';
                return;
            }
            
            container.innerHTML = courses.map(course => `
                <div class="course-card" onclick="selectCourse(${course.course_id}, this)">
                    <div class="course-name">${course.subject_name}</div>
                    <div class="course-subject">${course.course_name}</div>
                    <div class="course-group">–ì—Ä—É–ø–ø–∞: ${course.group_name}</div>
                </div>
            `).join('');
        }

        // –í—ã–±–æ—Ä –∫—É—Ä—Å–∞
        async function selectCourse(courseId, element) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—Å
            element.classList.add('active');
            
            currentCourseId = courseId;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            await Promise.all([
                loadAttributes(courseId),
                loadStudents(courseId)
            ]);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏
            document.getElementById('attributesSection').style.display = 'block';
            document.getElementById('studentsSection').style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫—É—Ä—Å–∞
        async function loadAttributes(courseId) {
            try {
                const response = await fetch(`/api/professor/course/attributes?course_id=${courseId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load attributes');
                }
                
                currentAttributes = await response.json();
                displayAttributes(currentAttributes);
            } catch (error) {
                document.getElementById('attributesContainer').innerHTML = 
                    '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤: ' + error.message + '</div>';
            }
        }

        function displayAttributes(attributes) {
            const container = document.getElementById('attributesContainer');
            
            if (attributes.length === 0) {
                container.innerHTML = '<div>–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è</div>';
                return;
            }
            
            container.innerHTML = attributes.map(attr => `
                <div class="attribute-card">
                    <div class="attribute-name">${attr.name}</div>
                    <div class="attribute-max">–ú–∞–∫—Å. –±–∞–ª–ª–æ–≤: ${attr.max_points}</div>
                </div>
            `).join('');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫—É—Ä—Å–∞
        async function loadStudents(courseId) {
            try {
                const response = await fetch(`/api/professor/course/students?course_id=${courseId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load students');
                }
                
                const students = await response.json();
                displayStudents(students);
            } catch (error) {
                document.getElementById('studentsContainer').innerHTML = 
                    '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: ' + error.message + '</div>';
            }
        }

        function displayStudents(students) {
            const container = document.getElementById('studentsContainer');
            
            if (students.length === 0) {
                container.innerHTML = '<div class="loading">–ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —ç—Ç–æ–º –∫—É—Ä—Å–µ</div>';
                return;
            }
            
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –≤–≤–æ–¥–∞ –±–∞–ª–ª–æ–≤
            const attributeId = currentAttributes.length > 0 ? currentAttributes[0].id : 0;
            const attributeName = currentAttributes.length > 0 ? currentAttributes[0].name : '–ë–∞–ª–ª—ã';
            const maxPoints = currentAttributes.length > 0 ? currentAttributes[0].max_points : 100;
            
            container.innerHTML = `
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                            <th>${attributeName}</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr>
                                <td>${student.student_name}</td>
                                <td>
                                    <input 
                                        type="number" 
                                        class="points-input" 
                                        value="${student.points}" 
                                        min="0" 
                                        max="${maxPoints}"
                                        step="0.1"
                                        id="points_${student.student_id}"
                                    />
                                    / ${maxPoints}
                                </td>
                                <td>
                                    <button 
                                        class="save-btn" 
                                        onclick="savePoints(${student.student_id}, ${attributeId})"
                                    >
                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
        async function savePoints(studentId, attributeId) {
            const pointsInput = document.getElementById(`points_${studentId}`);
            const points = parseFloat(pointsInput.value);
            const maxPoints = currentAttributes.find(attr => attr.id === attributeId)?.max_points || 100;

            if (points < 0 || points > maxPoints) {
                alert(`–ë–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 0 –¥–æ ${maxPoints}`);
                return;
            }

            try {
                const response = await fetch('/api/professor/update-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        student_id: studentId,
                        course_id: currentCourseId,
                        attribute_id: attributeId,
                        points: points
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save points');
                }

                showMessage('–ë–∞–ª–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            document.querySelector('.main-content').insertBefore(messageDiv, document.querySelector('.control-panel'));
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }
                
                const data = await response.json();
                if (data.user_type !== 'Professor') {
                    window.location.href = '/dashboard';
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å—ã –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                loadCourses();
            } catch (error) {
                window.location.href = '/';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkAuth();
    </script>
</body>
</html>